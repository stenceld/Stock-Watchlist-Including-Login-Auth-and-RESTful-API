<!-- I certify that this file I am submitting is all my own work. 
None of it is copied from any source or any person. -->
<!-- Signed: Dominic Stencel  Date: 11/24/2025 -->
<!-- Author: Dominic Stencel -->
<!-- Date: 11/24/2025 -->
<!-- Class: CSC305 -->
<!-- Project: Assignment 5 - RESTful API and Login Authentication -->
<!-- File Name: public/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Watchlist</title>
</head>
<body>
    <!-- Auth Section - Shown when user is not logged in -->
    <section id="authSection">
        <h1>Stock Watchlist - Login</h1>

        <!-- Register Form -->
        <h2>Register</h2>
        <form id="registerForm">
            <label for="regUsername">Username:</label>
            <input type="text" id="regUsername" name="username" required>

            <label for="regPassword">Password:</label>
            <input type="password" id="regPassword" name="password" required>

            <button type="submit">Register</button>
        </form>

        <!-- Login Form -->
        <h2>Login</h2>
        <form id="loginForm">
            <label for="loginUsername">Username:</label>
            <input type="text" id="loginUsername" name="username" required>

            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" name="password" required>

            <button type="submit">Login</button>
        </form>

        <div id="authMessage"></div>
    </section>

    <!-- Dashboard Section - Shown when user is logged in -->
    <section id="dashboardSection" class="hidden">
        <button id="logoutBtn">Logout</button>

        <!-- Add Stock Form -->
        <h2>Add Stock</h2>
        <form id="addStockForm">
            <label for="ticker">Ticker Symbol:</label>
            <input type="text" id="ticker" name="ticker" required>

            <label for="sharesOwned">Shares Owned:</label>
            <input type="number" id="sharesOwned" name="sharesOwned" min="1" required>

            <label for="purchasePrice">Purchase Price:</label>
            <input type="number" id="purchasePrice" name="purchasePrice" step="0.01" min="0" required>

            <button type="submit">Add to Watchlist</button>
        </form>

        <div id="stockMessage"></div>

        <hr>

        <!-- Watchlist Display -->
        <h2>Your Watchlist</h2>
        <div id="watchlist">
            <p>Loading watchlist...</p>
        </div>

        <!-- Portfolio Summary -->
        <h3>Portfolio Summary</h3>
        <div id="portfolioSummary"></div>
    </section>

    <script>
        // API Base URL
        const API_URL = "http://localhost:3000/api";

        // ============================================
        // Page Load - Check if user is logged in
        // ============================================
        window.addEventListener("DOMContentLoaded", function() {
            const token = localStorage.getItem("token");

            if (token) {
                // User is logged in, show dashboard
                showDashboard();
                fetchWatchlist();
            } else {
                // User is not logged in, show auth section
                showAuth();
            }
        });

        // ============================================
        // Show/Hide Sections
        // ============================================
        function showAuth() {
            document.getElementById("authSection").classList.remove("hidden");
            document.getElementById("dashboardSection").classList.add("hidden");
        }

        function showDashboard() {
            document.getElementById("authSection").classList.add("hidden");
            document.getElementById("dashboardSection").classList.remove("hidden");
        }

        // ============================================
        // Register Form Submit
        // ============================================
        document.getElementById("registerForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const username = document.getElementById("regUsername").value;
            const password = document.getElementById("regPassword").value;

            try {
                const response = await fetch(API_URL + "/users/register", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ username: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById("authMessage").innerHTML = 
                        "<p>Registration successful! Please login.</p>";
                    document.getElementById("registerForm").reset();
                } else {
                    document.getElementById("authMessage").innerHTML = 
                        "<p>Error: " + data.error + "</p>";
                }
            } catch (error) {
                document.getElementById("authMessage").innerHTML = 
                    "<p>Error: " + error.message + "</p>";
            }
        });

        // ============================================
        // Login Form Submit
        // ============================================
        document.getElementById("loginForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const username = document.getElementById("loginUsername").value;
            const password = document.getElementById("loginPassword").value;

            try {
                const response = await fetch(API_URL + "/users/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ username: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Save token to localStorage
                    localStorage.setItem("token", data.token);
                    document.getElementById("loginForm").reset();
                    showDashboard();
                    fetchWatchlist();
                } else {
                    document.getElementById("authMessage").innerHTML = 
                        "<p>Error: " + data.error + "</p>";
                }
            } catch (error) {
                document.getElementById("authMessage").innerHTML = 
                    "<p>Error: " + error.message + "</p>";
            }
        });

        // ============================================
        // Logout Button
        // ============================================
        document.getElementById("logoutBtn").addEventListener("click", function() {
            localStorage.removeItem("token");
            showAuth();
            document.getElementById("authMessage").innerHTML = "";
        });

        // ============================================
        // Add Stock Form Submit
        // ============================================
        document.getElementById("addStockForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const ticker = document.getElementById("ticker").value;
            const sharesOwned = document.getElementById("sharesOwned").value;
            const purchasePrice = document.getElementById("purchasePrice").value;
            const token = localStorage.getItem("token");

            try {
                const response = await fetch(API_URL + "/stocks", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        sharesOwned: sharesOwned,
                        purchasePrice: purchasePrice
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById("stockMessage").innerHTML = 
                        "<p>" + data.message + "</p>";
                    document.getElementById("addStockForm").reset();
                    fetchWatchlist();
                } else {
                    if (response.status === 401) {
                        // Token expired or invalid
                        localStorage.removeItem("token");
                        showAuth();
                    }
                    document.getElementById("stockMessage").innerHTML = 
                        "<p>Error: " + data.error + "</p>";
                }
            } catch (error) {
                document.getElementById("stockMessage").innerHTML = 
                    "<p>Error: " + error.message + "</p>";
            }
        });

        // ============================================
        // Fetch and Display Watchlist
        // ============================================
        async function fetchWatchlist() {
            const token = localStorage.getItem("token");

            try {
                const response = await fetch(API_URL + "/stocks", {
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayWatchlist(data.stocks);
                    displayPortfolio(data.portfolio);
                } else {
                    if (response.status === 401) {
                        // Token expired or invalid
                        localStorage.removeItem("token");
                        showAuth();
                    }
                    document.getElementById("watchlist").innerHTML = 
                        "<p>Error loading watchlist.</p>";
                }
            } catch (error) {
                document.getElementById("watchlist").innerHTML = 
                    "<p>Error: " + error.message + "</p>";
            }
        }

        // ============================================
        // Display Watchlist Table
        // ============================================
        function displayWatchlist(stocks) {
            if (stocks.length === 0) {
                document.getElementById("watchlist").innerHTML = 
                    "<p>Your watchlist is empty. Add some stocks!</p>";
                return;
            }

            let html = "<table>";
            html += "<tr>";
            html += "<th>Ticker</th>";
            html += "<th>Company Name</th>";
            html += "<th>Shares</th>";
            html += "<th>Purchase Price</th>";
            html += "<th>Current Price</th>";
            html += "<th>Total Value</th>";
            html += "<th>Profit/Loss</th>";
            html += "<th>Action</th>";
            html += "</tr>";

            for (const stock of stocks) {
                html += "<tr>";
                html += "<td>" + stock.ticker + "</td>";
                html += "<td>" + stock.companyName + "</td>";
                html += "<td>" + stock.sharesOwned + "</td>";
                html += "<td>$" + stock.purchasePrice.toFixed(2) + "</td>";
                html += "<td>$" + stock.currentPrice.toFixed(2) + "</td>";
                html += "<td>$" + stock.currentValue.toFixed(2) + "</td>";
                html += "<td>$" + stock.profitLoss.toFixed(2) + "</td>";
                html += "<td><button onclick=\"deleteStock('" + stock._id + "')\">Delete</button></td>";
                html += "</tr>";
            }

            html += "</table>";
            document.getElementById("watchlist").innerHTML = html;
        }

        // ============================================
        // Display Portfolio Summary
        // ============================================
        function displayPortfolio(portfolio) {
            let html = "<p><strong>Total Value:</strong> $" + portfolio.totalCurrentValue.toFixed(2) + "</p>";
            html += "<p><strong>Total Cost Basis:</strong> $" + portfolio.totalCostBasis.toFixed(2) + "</p>";
            html += "<p><strong>Total Profit/Loss:</strong> $" + portfolio.totalProfitLoss.toFixed(2) + "</p>";
            document.getElementById("portfolioSummary").innerHTML = html;
        }

        // ============================================
        // Delete Stock
        // ============================================
        async function deleteStock(stockId) {
            const token = localStorage.getItem("token");

            try {
                const response = await fetch(API_URL + "/stocks/" + stockId, {
                    method: "DELETE",
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById("stockMessage").innerHTML = 
                        "<p>" + data.message + "</p>";
                    fetchWatchlist();
                } else {
                    if (response.status === 401) {
                        localStorage.removeItem("token");
                        showAuth();
                    }
                    document.getElementById("stockMessage").innerHTML = 
                        "<p>Error: " + data.error + "</p>";
                }
            } catch (error) {
                document.getElementById("stockMessage").innerHTML = 
                    "<p>Error: " + error.message + "</p>";
            }
        }
    </script>
</body>
</html>